## Обновление ядра

Текущая версия ядра

`uname -r`

4.18.0-305.19.1.el8_4.x86_64


Раскомментировать репозитории

```
sudo -s
cd /etc/yum.repos.d/
sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
cd ~
```

Установка репозитория elrepo

```
yum install -y https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm
```

Установка нового ядра из репозитория elrepo-kernel

```
yum --enablerepo elrepo-kernel install kernel-ml -y
```

Обновление параметров GRUB

```
grub2-mkconfig -o /boot/grub2/grub.cfg
grub2-set-default 0
```

Перезагрузка

`shutdown -r now`

Новая версия ядра

`uname -r`

6.1.2-1.el8.elrepo.x86_64


---


## **Packer**

### **packer provision config**
Файл `centos.json` содержит описание того, как произвольный образ. Полное описание можно найти в документации к `packer`. Обратим внимание на основные секции или ключи.

Создаем переменные (`variables`) с версией и названием нашего проекта (artifact):
```
    "artifact_description": "CentOS 7.7 with kernel 5.x",
    "artifact_version": "7.7.1908",
```

В секции `builders` задаем исходный образ, для создания своего в виде ссылки и контрольной суммы. Параметры подключения к создаваемой виртуальной машине.

```
    "iso_url": "http://mirror.yandex.ru/centos/7.7.1908/isos/x86_64/CentOS-7-x86_64-Minimal-1908.iso",
    "iso_checksum": "9a2c47d97b9975452f7d582264e9fc16d108ed8252ac6816239a3b58cef5c53d",
    "iso_checksum_type": "sha256",
```
В секции `post-processors` указываем имя файла, куда будет сохранен образ, в случае успешной сборки

```
    "output": "centos-{{user `artifact_version`}}-kernel-5-x86_64-Minimal.box",
```

В секции `provisioners` указываем каким образом и какие действия необходимо произвести для настройки виртуальой машины. Именно в этой секции мы и обновим ядро системы, чтобы можно было получить образ с 5й версией ядра. Настройка системы выполняется несколькими скриптами, заданными в секции `scripts`.

```
    "scripts" : 
      [
        "scripts/stage-1-kernel-update.sh",
        "scripts/stage-2-clean.sh"
      ]
```
Скрипты будут выполнены в порядке указания. Первый скрипт включает себя набор команд, которые мы ранее выполняли вручную, чтобы обновить ядро. Второй скрипт занимается подготовкой системы к упаковке в образ. Она заключается в очистке директорий с логами, временными файлами, кешами. Это позволяет уменьшить результирующий образ. Более подробно можно ознакомиться с ними в директории `packer/scripts`

Секция `post-processors` описывает постобработку виртуальной машины при ее выгрузке. Мы указыаем имя файла, в который будет сохранен результат (artifact). Обратите внимание, что имя задается на основе ранее созданной пользовательской переменной `artifact_version` значение которой мы задали ранее:

```
    "output": "centos-{{user `artifact_version`}}-kernel-5-x86_64-Minimal.box",
```

### **packer build**
Проверка файла конфигурации:

``` 
packer inspect centos.json
```

Создание образа системы:

```
packer build centos.json
```

Если все в порядке, то, согласно файла `config.json` будет скачан исходный iso-образ CentOS, установлен на виртуальную машину в автоматическом режиме, обновлено ядро и осуществлен экспорт в указанный нами файл. Если не вносилось изменений в предложенные файлы, то в текущей директории мы увидим файл `centos-7.7.1908-kernel-5-x86_64-Minimal.box`. Он и является результатом работы `packer`.

### **vagrant init (тестирование)**
Проведем тестирование созданного образа. Выполним его импорт в `vagrant`:

```
vagrant box add --name centos-7-5 centos-7.7.1908-kernel-5-x86_64-Minimal.box
```

Проверим его в списке имеющихся образов (ваш вывод может отличаться):

```
vagrant box list
centos-7-5            (virtualbox, 0)
```

Он будет называться `centos-7-5`, данное имя мы задали при помощи параметра `name` при импорте.

Теперь необходимо провести тестирование полученного образа. Для этого создадим новый Vagrantfile или воспользуемся имеющимся. Для нового создадим директорию `test` и в ней выполним:

```
vagrant init centos-7-5
```

Для имеющегося произведем замену значения `box_name` на имя импортированного образа. Соотвествующая строка примет вид:

```
:box_name => "centos-7-5",
```

Теперь запустим виртуальную машину, подключимся к ней и проверим, что у нас в ней новое ядро:

```
vagrant up
...
vagrant ssh    
```

и внутри виртуальной машины:

```
[vagrant@kernel-update ~]$ uname -r
5.3.1-1.el7.elrepo.x86_64
```

Если все в порядке, то машина будет запущена и загрузится с новым ядром. В данном примере это `5.3.1`.

Удалим тестовый образ из локального хранилища:
```
vagrant box remove centos-7-5
```
